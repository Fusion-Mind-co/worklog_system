# パスワードリセット機能 - 実装ガイド

## 実装概要

パスワードリセット機能は以下の2つの方法をサポートします：

1. **メールによるリセット**:
   - ユーザーが登録済みのメールアドレスを使ってリセットリンクを受け取る
   - リセットリンクから新しいパスワードを設定できる

2. **管理者への依頼**:
   - メールアドレスが未登録または利用できないユーザー向け
   - 管理者がパスワードをリセットし、ユーザーに通知する

## 実装手順

### 1. データベース設定

まず、パスワードリセット用のテーブルを作成するためにマイグレーションを実行します：

```bash
flask db migrate -m "Add password reset tables"
flask db upgrade
```

この操作によって、`password_reset_requests`テーブルが作成されます。

### 2. フロントエンドの設定

1. React Routerの設定ファイルに新しいルートを追加：

```jsx
// src/App.jsx または routes.js

// ...その他のインポート...
import ResetPassword from '@/pages/ResetPassword';

function App() {
  return (
    <Routes>
      {/* 既存のルート... */}
      <Route path="/password-reset" element={<ResetPassword />} />
    </Routes>
  );
}
```

2. `ForgotPasswordModal.jsx`をコンポーネントディレクトリに配置：
   
```bash
cp ForgotPasswordModal.jsx src/components/
```

3. Auth.jsxを更新して、モーダルコンポーネントをインポートし、「パスワードをお忘れですか？」ボタンにモーダル表示のイベントハンドラを追加します

### 3. バックエンドの設定

1. メール送信機能の設定

Flaskのconfig.pyファイルにSMTP設定を追加：

```python
class Config:
    # ...既存の設定...
    
    # メール設定
    SMTP_SERVER = os.getenv('SMTP_SERVER', 'smtp.gmail.com')
    SMTP_PORT = int(os.getenv('SMTP_PORT', 587))
    SMTP_USERNAME = os.getenv('SMTP_USERNAME', 'your-email@gmail.com')
    SMTP_PASSWORD = os.getenv('SMTP_PASSWORD', 'your-password-or-app-password')
    SENDER_EMAIL = os.getenv('SENDER_EMAIL', 'no-reply@example.com')
```

2. テンプレートディレクトリの作成

```bash
mkdir -p templates/emails
```

3. メールテンプレートとパスワードリセットページのテンプレートを配置

```bash
cp templates/*.html templates/
cp templates/emails/*.html templates/emails/
```

### 4. パスワードリセット機能のテスト

以下の手順で機能をテストします：

1. **メールリセットのテスト**:
   - ログイン画面で「パスワードをお忘れですか？」をクリック
   - 「メールで再設定」タブを選択
   - 社員IDとメールアドレスを入力して送信
   - メールを確認してリセットリンクをクリック
   - 新しいパスワードを設定

2. **管理者依頼のテスト**:
   - ログイン画面で「パスワードをお忘れですか？」をクリック
   - 「管理者に依頼」タブを選択
   - 社員IDと依頼理由を入力して送信
   - 管理者メールを確認（実装段階では管理者ツールは未実装のため、メールのみ確認）

## 注意点

1. 本番環境では、SMTPサーバーの設定を適切に行ってください。開発環境では、[Mailtrap](https://mailtrap.io/)などのテスト用メールサービスが便利です。

2. セキュリティのため、トークンは十分に長く、推測困難な形式で生成しています。有効期限は24時間に設定されています。

3. 管理者向け機能は基本実装のみで、実際の管理者ツールでの操作部分は今後の開発で実装予定です。

4. メールテンプレートは必要に応じてカスタマイズしてください。現在はシンプルなHTMLテンプレートが実装されています。

## 次のステップ

1. 管理者ツールにパスワードリセット依頼を管理する機能を追加
2. パスワード強度のチェック機能強化
3. リセット履歴のログ記録と監査機能の追加